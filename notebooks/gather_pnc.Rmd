---
title: "PNC Demographics"
output: html_notebook
---

Below follows the preprocessing of the PNC demographics data. We ultimately want:

-   Age
-   Sex
-   Race
-   Education
-   Handedness
-   Parent's education
-   BMI

```{r}
library(tidyverse)
library(naniar)
library(ggsankey)
library(forcats)
library(here)

data_path <- here("data")
```

# Read in

```{r, cache=TRUE}
pnc_raw1 <- read_csv(here("data", "pnc_data.csv")) %>% 
  rename(participant_id=bblid)
pnc_raw2 <- read_csv(here("data", "bblid_renamed.csv")) %>%
      rename(participant_id=reid)
pnc_raw3 <- read_csv(here("data", "PNC_cnb_factor_scores_tymoore_20151006.csv")) %>%
  left_join(pnc_raw2)
pnc_raw4 <- read_csv(here("data", "PNC_cnb_wrat_scores_20161215.csv")) %>%
  left_join(pnc_raw2)
pnc_raw5 <- read_csv(here("data", "n1601_cnb_zscores_all_fr_20161215.csv")) %>%
  left_join(pnc_raw2)
pnc_raw6 <- read_csv(here("data", "n14513_goassess_screener_nontext_corrected_for_scala_20131021_redcap_pid272_fixed_20131101.csv")) %>%
  mutate(bblid = PROBAND_BBLID) %>%
  left_join(pnc_raw2)
pnc_data <- pnc_raw1  %>%
  left_join(
    pnc_raw2
    ) %>%
  left_join(
    pnc_raw3
    ) %>%
  left_join(
    pnc_raw4
    ) %>%
  left_join(
    pnc_raw5
    ) %>%
  left_join(
    pnc_raw6
    ) %>%
  mutate(participant_id = str_c("sub-", participant_id))
```

```{r}
pnc_data %>%
  sample_n(30)
```

Let's grab the first relevant variables

# Age

```{r}
pnc_ <- pnc_data %>%
  mutate(age = as.numeric(ageAtScan1)/12)
```

```{r}
qplot(pnc_$age)
```

# Sex

```{r}
pnc_ <- pnc_ %>%
  mutate(
    sex = case_when(sex=="1" ~ "Male", sex=="2"~ "Female") %>% as.factor()
  )
```

```{r}
qplot(pnc_$sex)
```

# Race

```{r}
pnc_ %>%
  select(race) %>%
  table()
```

Only want: black, white, asian, mixed, other, unknown, hispanic

```{r}
# 1= White; 2= BlackBlack/African American; 3= US_India/Alaska Native;4=Asian; 5=More Than One Race; 6=Hawaiian/Pacific; 9=Unknown/Unreported
pnc_ <- pnc_ %>%
  mutate(race_old = case_when(
    race == 1  ~ "White",
    race == 2  ~ "Black/African American",
    race == 3  ~ "US_India/Alaska Native",
    race == 4  ~ "Asian",
    race == 5  ~ "More Than Once Race",
    race == 6  ~ "Hawaiian/Pacific",
    race == 9  ~ "Uknown/Unreported"
  ) %>% factor()
)

```

```{r}
race_levels <- c("Black", "White", "Asian", "Mixed", "Hispanic", "Other", "Unknown")
  
pnc_ <- pnc_ %>%
  mutate(
    race = case_when(
    race_old == "White"                             ~ "White",
    race_old == "Black/African American"            ~ "Black",
    race_old == "Asian"                             ~ "Asian",
    race_old == "US_India/Alaska Native"            ~ "Other",
    race_old == "Hawaiian/Pacific"                  ~ "Other",
    race_old == "American Indian/Alaskan Native"    ~ "Other",
    race_old == "More Than Once Race"               ~ "Mixed",
    str_detect(race_old, "Other")                   ~ "Other",
    str_detect(race_old, "Unknown")                 ~ "Unknown",
    
  ), #%>% factor(levels = race_levels),
  race = case_when(ethnicity == 1 ~ "Hispanic", TRUE ~ race) %>% factor()
  )
```

```{r}
pnc_ %>%
  ggplot(aes(x=race)) +
  geom_bar()
```

```{r}
pnc_ %>%
  ggsankey::make_long(race_old, race) %>%
  ggplot(aes(x = x,
             next_x = next_x,
             node = node,
             next_node = next_node,
             fill = factor(node),
             label = node)) +
  theme_bw() +
  geom_sankey(node.colour = "black", show.legend = FALSE) +
  geom_sankey_label(size = 2, color = "black", fill= "white", hjust = -0.5, check_overlap=TRUE) +
  theme(legend.position = "none") +
  theme(axis.title = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.ticks = element_blank()) +
  labs(title = "Old name -> New name for race categories")
```

# Education

We have the following input for education:

```{r}
pnc_ <- pnc_ %>%
  mutate(education_years=as.numeric(edu1))
```

```{r}
pnc_$education_years %>%
  table()
```

```{r}
pnc_ %>%
  ggplot(aes(x=education_years)) +
  geom_bar() +
  theme(axis.text.x = element_text(angle=45, hjust = 1))
```

# Parent Education


```{r}
pnc_ %>%
  mutate(education_f = fedu1, education_m = medu1) -> pnc_

pnc_ %>%
  select(education_f, education_m) %>%
  pivot_longer(c(education_f, education_m), names_to = c("parent"), values_to = c("years")) %>%
  ggplot(aes(x=years)) +
  geom_bar(aes(fill=parent), position="dodge")
```

# Handedness

```{r}
pnc_$handednessv2 %>%
  qplot()
```

Most folks are right handed:

```{r}
pnc_ %>%
  mutate(handedness = case_when(
    handednessv2 == 1 ~ "Right",
    handednessv2 == 2 ~ "Left",
    handednessv2 == 3 ~ "Ambidextrous"
    ) %>% factor()
  ) -> pnc_
```

```{r}
pnc_$handedness %>%
  qplot()
```

# BMI

No BMI in the PNC inputs

```{r}
pnc_$bmi <- NA
```

# Summary

```{r}
pnc_final <- pnc_ %>%
  mutate(wave = timepoint,
         study = "PNC",
         selection = "Community"
  ) %>%
  mutate(study_site = "PNC-1") %>%
  select(participant_id, study, study_site, wave, age, sex, race, handedness, education_years, education_f, education_m, bmi)
```

```{r}
gg_miss_var(pnc_final, show_pct = TRUE)
```
# Outputs

We write the output to RDS as well as the data dictionary.

```{r}
pnc_final %>%
  write_rds(here("outputs", "pnc_data.rds"))
```

```{r}
age <- list(
  LongName = "ParticipantAge",
  Description = "Participant age in years at the time of scan/intake. If original data is collected in months, the final value is divided by 12.",
  Units = "Years"
)

race <- list(
  LongName = "ParticipantRace",
  Description = "Participant's race.",
  Levels = levels(pnc_final$race)
)

sex <- list(
  LongName = "ParticipantSex",
  Description = "Participant's sex.",
  Levels = levels(pnc_final$sex)
)

bmi <- list(
  LongName = "ParticipantBMI",
  Description = "Participant's Body Mass Index. ",
  TermURL = "https://www.cdc.gov/nccdphp/dnpao/growthcharts/training/bmiage/page5_2.html",
  Units = "lbs/inches^2; BMI is normally reported without units."
)

handedness <- list(
  LongName = "ParticipantHandedness",
  Description = "Participant handedness. Either self-reported, or result of binarizing the Edinburgh Handedness Scale. Participants whose Edinburgh Handedness Scale value is 0 are reported as Ambidextrous",
  Levels = levels(pnc_final$handedness),
  TermURL = "https://en.wikipedia.org/wiki/Edinburgh_Handedness_Inventory"
)

education_years <- list(
  LongName = "ParticipantEducation",
  Description = "Participant education in years at time of scan/intake."
)

education_f <- list(
  LongName = "FatherEducation",
  Description = "Father's education level at time of scan/intake.",
  Levels = levels(pnc_final$education_f)
)

education_m <- list(
  LongName = "MotherEducation",
  Description = "Mother's education level at time of scan/intake.",
  Levels = levels(pnc_final$education_m)
)

wave <- list(
  LongName = "ParticipantWave",
  Description = "Participant's recruitment wave.",
  Levels = levels(pnc_final$wave)
)

study_site <- list(
  LongName = "ParticipantStudySite",
  Description = "Participant's study recruitment site.",
  Levels = levels(pnc_final$study_site)
)

study <- list(
  LongName = "ParticipantStudy",
  Description = "Participant's study.",
  Levels = levels(pnc_final$study)
)

list(age=age, 
     race=race, 
     sex=sex, 
     bmi=bmi, 
     handedness=handedness, 
     education_years=education_years, 
     education_f=education_f, 
     education_m=education_m, 
     wave=wave, 
     study_site=study_site, 
     study=study) %>%
  #jsonlite::toJSON(auto_unbox = TRUE) %>%
  #jsonlite::prettify() %>%
  jsonlite::write_json(here("outputs", "pnc_dictionary.json"), auto_unbox=TRUE, pretty=TRUE)
```

