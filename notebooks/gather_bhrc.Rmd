---
title: "BHRC Demographics"
output: html_notebook
---

Below follows the preprocessing of the BHRC demographics data. We ultimately want:

-   Age
-   Sex
-   Race
-   Education
-   Handedness
-   Parent's education
-   BMI

```{r}
library(tidyverse)
library(naniar)
library(ggsankey)
library(forcats)
library(here)

data_path <- here("data")
```

# Read in

```{r, cache=TRUE}
# preprocess according to Mauricio
BHRC_data <- readRDS(here("data", "BHRC_2020_11_05.rds"))
mydata_w0 <- BHRC_data %>% dplyr::filter(redcap_event_name=="wave0_arm_1", dcany!="NA")
mydata_w1 <- BHRC_data %>% dplyr::filter(redcap_event_name=="wave1_arm_1", dcany!="NA")
mydata_w2 <- BHRC_data %>% dplyr::filter(redcap_event_name=="wave2_arm_1", dcany!="NA") %>% dplyr::select(-state, -gender, -skincolor)
mydata_complement <- BHRC_data %>% dplyr::filter(redcap_event_name=="wave0_arm_1") %>% dplyr::select(ident, state, gender, skincolor)
mydata_w2 <- left_join(mydata_w2,mydata_complement, by="ident") 
BHRC_data <- rbind(mydata_w0, mydata_w1, mydata_w2)
rm(mydata_w0, mydata_w1, mydata_w2, mydata_complement)

BHRC_ <- BHRC_data %>%
  mutate(participant_id = str_c("sub-", subjectid)) %>%
  mutate(wave = case_when(redcap_event_name=="wave0_arm_1" ~ 1, 
                          redcap_event_name=="wave1_arm_1" ~ 2,
                          redcap_event_name=="wave2_arm_1" ~ 3) %>% as.character())
```

```{r}
BHRC_ %>%
  sample_n(30) %>%
  select(-ident, -subjectid)
```

Let's grab the first relevant variables

# Age

```{r}
BHRC_ <- BHRC_ %>%
  mutate(age = as.numeric(age))
```

```{r}
qplot(BHRC_$age)
```

# Sex

```{r}

BHRC_ <- BHRC_ %>%
  mutate(
    sex = case_when(gender=="1" ~ "Male", gender=="2"~ "Female") %>% as.factor()
  )
```

```{r}
qplot(BHRC_$sex)
```

# Race

```{r}
BHRC_$Child_race <- BHRC_$skincolor
BHRC_ <- BHRC_ %>% mutate(
  Child_race2 = as.numeric(Child_race)
  ) %>%
  mutate(Child_race =  case_when(Child_race == 1 ~ "White",
                                  Child_race == 2 ~ "Black",
                                  Child_race == 3 ~ "Mixed",
                                  Child_race == 4 ~ "Native",
                                  Child_race == 5 ~ "Asian"))

BHRC_ %>%
  select(Child_race) %>%
  table()
```

Only want: black, white, asian, mixed, other, unknown, hispanic

```{r}
# 1= White; 2= BlackBlack/African American; 3= US_India/Alaska Native;4=Asian; 5=More Than One Race; 6=Hawaiian/Pacific; 9=Unknown/Unreported
BHRC_ <- BHRC_ %>%
  mutate(race_old = Child_race
)

```

```{r}
race_levels <- c("Black", "White", "Asian", "Mixed", "Hispanic", "Other", "Unknown")
  
BHRC_ <- BHRC_ %>%
  mutate(
    race = case_when(
    race_old == "White"            ~ "White",
    race_old == "Black"            ~ "Black",
    race_old == "Mixed"            ~ "Mixed",
    race_old == "Native"           ~ "Other",
    race_old == "Asian"            ~ "Asian"
  ) %>% factor(levels = race_levels)
  )
```

```{r}
BHRC_ %>%
  ggplot(aes(x=race)) +
  geom_bar()
```

```{r}
BHRC_ %>%
  ggsankey::make_long(race_old, race) %>%
  ggplot(aes(x = x,
             next_x = next_x,
             node = node,
             next_node = next_node,
             fill = factor(node),
             label = node)) +
  theme_bw() +
  geom_sankey(node.colour = "black", show.legend = FALSE) +
  geom_sankey_label(size = 2, color = "black", fill= "white", hjust = -0.5, check_overlap=TRUE) +
  theme(legend.position = "none") +
  theme(axis.title = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.ticks = element_blank()) +
  labs(title = "Old name -> New name for race categories")
```

# Education

We have the following input for education:

```{r}
BHRC_data_w0 <- BHRC_ %>% dplyr::filter(wave==1)
BHRC_data_w1 <- BHRC_ %>% dplyr::filter(wave==2)
BHRC_data_w2 <- BHRC_ %>% dplyr::filter(wave==3)

BHRC_data_w0 <- BHRC_data_w0 %>% mutate(School_repet= 
                case_when(fat24==1 ~ 1,
                          fat24==0 ~ 0,
                          fat24==99 ~ NA_real_))
BHRC_data_w0 <- BHRC_data_w0 %>% mutate(School_exp= 
                case_when(fat25==1|fat26==1 ~ 1,
                          fat25==0 & fat26==0 ~ 0,
                          fat25==99 ~ NA_real_))
BHRC_data_w0 <- BHRC_data_w0 %>% mutate(School_susp= 
                case_when(fat27==1 ~ 1,
                          fat27==0 ~ 0,
                          fat27==99 ~ NA_real_))

BHRC_data_w1 <- BHRC_data_w1 %>% mutate(School_repet= 
                case_when(le4_unite==1 ~ 1,
                          le4_unite==0 ~ 0,
                          le4_unite==99 ~ NA_real_))
BHRC_data_w1 <- BHRC_data_w1 %>% mutate(School_exp= 
                case_when(le5_unite==1|le7_unite==1|instlevel==13 ~ 1,
                          le5_unite==0 & le7_unite==0 & instlevel!=13 ~ 0,
                          le5_unite==99 & le7_unite==99 ~ NA_real_))
BHRC_data_w1 <- BHRC_data_w1 %>% mutate(School_susp= 
                case_when(le6_unite==1 ~ 1,
                          le6_unite==0 ~ 0,
                          le6_unite==99 ~ NA_real_))

BHRC_data_w2 <- BHRC_data_w2 %>% mutate(School_repet= 
                case_when(le4_unite==1 ~ 1,
                          le4_unite==0 ~ 0,
                          le4_unite==99 ~ NA_real_))
BHRC_data_w2 <- BHRC_data_w2 %>% mutate(School_exp= 
                case_when(le5_unite==1|le7_unite==1 ~ 1,
                          le5_unite==0 & le7_unite==0 ~ 0,
                          le5_unite==99 & le7_unite==99 ~ NA_real_))
BHRC_data_w2 <- BHRC_data_w2 %>% mutate(School_susp= 
                case_when(le6_unite==1 ~ 1,
                          le6_unite==0 ~ 0,
                          le6_unite==99 ~ NA_real_))

BHRC_ <- rbind(BHRC_data_w0, BHRC_data_w1, BHRC_data_w2)
rm(BHRC_data_w0, BHRC_data_w1, BHRC_data_w2)
BHRC_<-dplyr::rename(BHRC_,School_years=instlevel)
```

```{r}
school_labels <- BHRC_$School_years %>% attr("labels") %>%
  data.frame(School_years=.) %>%
  rownames_to_column(var = "Label") %>%
  mutate(
    education = 
      case_when(
        str_detect(Label, "Pre School")                ~ "Kindergarten",
        str_detect(Label, "grade")                     ~ str_extract(Label, "[\\S]{3} grade") %>%
          str_to_title(),
        str_detect(Label, "\\(High School\\)")         ~ str_c(as.character(scales::ordinal(School_years - 1)), " Grade"),
        str_detect(Label, "Finished") ~ "High School Diploma",
        str_detect(Label, "Dropped|Expelled|Arrested") ~ "Incomplete High School",
        School_years == 77                             ~ NA_character_
      )
    )
school_labels
```

```{r}
BHRC_ <- BHRC_ %>%
  left_join(school_labels)
```

```{r}
BHRC_ %>%
  ggplot(aes(x=education)) +
  geom_bar() +
  theme(axis.text.x = element_text(angle=45, hjust = 1))
```

```{r}
BHRC_ %>%
  ggsankey::make_long(Label, education) %>%
  ggplot(aes(x = x,
             next_x = next_x,
             node = node,
             next_node = next_node,
             fill = factor(node),
             label = node)) +
  theme_bw() +
  geom_sankey(node.colour = "black", show.legend = FALSE) +
  geom_sankey_label(size = 2, color = "black", fill= "white", hjust = -0.5, check_overlap=TRUE) +
  theme(legend.position = "none") +
  theme(axis.title = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.ticks = element_blank()) +
  labs(title = "Old name -> New name for education categories")
```


# Parent Education

No parent education data is provided.

# Handedness

Handedness is not provided

# BMI

No BMI in the BHRC inputs

```{r}
BHRC_<-BHRC_ %>%
  mutate(bmi=p_bmi)
```

# Summary

```{r}
BHRC_final <- BHRC_ %>%
  mutate(selection = case_when(selection==1 ~ "Community", 
                               selection==2 ~ "High_risk") %>% factor(),
         study = "BHRC") %>%
  mutate(study_site = case_when(state=="1" ~ "BHRC-1", state=="2"~ "BHRC-2")) %>%
  select(participant_id, study, study_site, wave, selection, age, sex, race, education, bmi)
```

```{r}
gg_miss_var(BHRC_final, show_pct = TRUE)
```
# Outputs

We write the output to RDS as well as the data dictionary.

```{r}
BHRC_final %>%
  write_rds(here("outputs", "BHRC_data.rds"))
```

```{r}
age <- list(
  LongName = "ParticipantAge",
  Description = "Participant age in years at the time of scan/intake. If original data is collected in months, the final value is divided by 12.",
  Units = "Years"
)

race <- list(
  LongName = "ParticipantRace",
  Description = "Participant's race.",
  Levels = levels(BHRC_final$race)
)

sex <- list(
  LongName = "ParticipantSex",
  Description = "Participant's sex.",
  Levels = levels(BHRC_final$sex)
)

bmi <- list(
  LongName = "ParticipantBMI",
  Description = "Participant's Body Mass Index. ",
  TermURL = "https://www.cdc.gov/nccdphp/dnpao/growthcharts/training/bmiage/page5_2.html",
  Units = "lbs/inches^2; BMI is normally reported without units."
)

education_years <- list(
  LongName = "ParticipantEducation",
  Description = "Participant education in years at time of scan/intake."
)

wave <- list(
  LongName = "ParticipantWave",
  Description = "Participant's recruitment wave.",
  Levels = levels(BHRC_final$wave)
)

study_site <- list(
  LongName = "ParticipantStudySite",
  Description = "Participant's study recruitment site.",
  Levels = levels(BHRC_final$study_site)
)

selection <- list(
  LongName = "ParticipantSelectionType",
  Description = "Participant selected from which community group",
  Levels = levels(BHRC_final$selection)
)

study <- list(
  LongName = "ParticipantStudy",
  Description = "Participant's study.",
  Levels = levels(BHRC_final$study)
)

list(age=age, 
     race=race, 
     sex=sex, 
     bmi=bmi, 
     selection=selection,
     education=education, 
     wave=wave, 
     study_site=study_site, 
     study=study) %>%
  #jsonlite::toJSON(auto_unbox = TRUE) %>%
  #jsonlite::prettify() %>%
  jsonlite::write_json(here("outputs", "BHRC_dictionary.json"), auto_unbox=TRUE, pretty=TRUE)
```

