---
title: "ECAS Demographics"
output: html_notebook
---

Below follows the preprocessing of the ECAS demographics data. We ultimately want:

-   Age
-   Sex
-   Race
-   Education
-   Handedness
-   Parent's education
-   BMI

```{r}
library(tidyverse)
library(naniar)
library(ggsankey)
library(forcats)
library(here)

data_path <- here("data")
```

# Read in

```{r, cache=TRUE}
ecas_raw <- read_csv(here(data_path, "RBC_vars_send_to_Ted.csv")) %>%
  mutate(old_id = str_remove(IDENT_SUBID, "_.+"))

ecas_labels <- read_csv("/cbica/projects/RBC/RBC_RAWDATA/bidsdatasets/ECAS/RBC_ECAS_IDs.csv")

ecas_ <- ecas_labels %>%
  left_join(ecas_raw) %>%
  mutate(participant_id = hashed) %>%
  select(-c(old_id, original, IDENT_SUBID, hashed)) %>%
  select(participant_id, everything())
```

```{r}
ecas_ %>%
  sample_n(30)
```

# Age

```{r}
message("No age provided")
ecas_$age <- NA
```

```{r, eval=FALSE}
qplot(ecas_$age)
```

# Sex

```{r}
message("no data dictionary for male vs. female given")
sex_levels <- c("Male", "Female", "Other")
ecas_ <- ecas_ %>%
  mutate(sex = case_when(
    DEM_3_GENDER_CHILD == 0    ~ "Male",
    DEM_3_GENDER_CHILD == 1    ~ "Female",
    TRUE                        ~ "Other"
  ) %>% factor(levels = sex_levels))

```

```{r}
qplot(ecas_$sex)
```

Are we sure that `0 = male` and `1 = female`?

# Race

We're given:

```
1 = "American Indian / Alaska Native"
2 = "Asian"
3 = "Native Hawaiian/Other Pacific Islander"
4 = "Black"
5 = "White"
6 = "More than 1 race"
7 = "Unknown/not reported"

```

```{r}
ecas_ %>%
  select(RACE) %>%
  table()
```

Only want: black, white, asian, mixed, other, unknown, hispanic

```{r}
ecas_ <- ecas_ %>%
  mutate(race_old = case_when(
    `RACE` == 1  ~ "American Indian / Alaskan Native",
    `RACE` == 2  ~ "Asian",
    `RACE` == 3  ~ "Native Hawaiian/Other Pacific Islander",
    `RACE` == 4  ~ "Black",
    `RACE` == 5  ~ "White",
    `RACE` == 6  ~ "More than 1 race",
    `RACE` == 7  ~ "Unknown/not reported"
  ) %>% factor()
)

```

```{r}
race_levels <- c("Black", "White", "Asian", "Mixed", "Hispanic", "Other", "Unknown")
  
ecas_ <- ecas_ %>%
  mutate(
    race = case_when(
    race_old == "American Indian / Alaskan Native"       ~ "Other",
    race_old == "Asian"                                  ~ "Asian",
    race_old == "Native Hawaiian/Other Pacific Islander" ~ "Hispanic",
    race_old == "Black"                                  ~ "Black",
    race_old == "White"                                  ~ "White",
    race_old == "More than 1 race"                       ~ "Mixed",
    race_old == "Unknown/not reported"                   ~ "Unknown"
  ) %>% factor(levels = race_levels))
```

```{r}
ecas_ %>%
  ggplot(aes(x=race)) +
  geom_bar()
```

```{r}
ecas_ %>%
  ggsankey::make_long(race_old, race) %>%
  ggplot(aes(x = x,
             next_x = next_x,
             node = node,
             next_node = next_node,
             fill = factor(node),
             label = node)) +
  theme_bw() +
  geom_sankey(node.colour = "black", show.legend = FALSE) +
  geom_sankey_label(size = 2, color = "black", fill= "white", hjust = -0.5, check_overlap=TRUE) +
  theme(legend.position = "none") +
  theme(axis.title = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.ticks = element_blank()) +
  labs(title = "Old name -> New name for race categories")
```

# Education

We have the following input for education:

```{r}
table(ecas_$SCHOOLGRADE)
```

Assuming 0 and 0.5 are kindergarten:

```{r}
education_levels <- c("Kindergarten", str_c(scales::ordinal(1:12), " Grade"))

ecas_ <- ecas_ %>%
  mutate(
    education = case_when(
      SCHOOLGRADE < 1        ~ "Kindergarten",
      TRUE                   ~ str_c(scales::ordinal(SCHOOLGRADE), " Grade")
    ),
    education = str_replace(education, ";", "") %>% factor(levels = education_levels)
  )
```

```{r}
ecas_$education %>%
  table()
```

```{r}
ecas_ %>%
  ggplot(aes(x=education)) +
  geom_bar() +
  theme(axis.text.x = element_text(angle=45, hjust = 1))
```

# Parent Education


```{r}
message("no parent education provided")
ecas_$education_f <- NA
ecas_$education_m <- NA
```

# Handedness

```{r}
message("no handedness provided")
ecas_$handedness <- NA
```

# BMI

We use the [CDC formula for BMI](https://www.cdc.gov/nccdphp/dnpao/growthcharts/training/bmiage/page5_2.html):

$ \frac{ \text{weight} (lb)} { \text{height} (in)^2 \times 703}$ 

```{r}
# we get height in inches from vtl007 in the data dictionary
ecas_ <- ecas_ %>%
  mutate(bmi = (BMI_WEIGHT / BMI_HEIGHT^2) * 703)
```

```{r}
ecas_ %>%
  ggplot(aes(x=bmi)) +
  geom_histogram()
```

# Summary

```{r}
ecas_final <- ecas_ %>%
  mutate(wave = "1",
         study = "PACCT" %>% factor(),
         Site = "PACCT"
  ) %>%
  mutate(study_site = "PACCT") %>%
  select(participant_id, study, study_site, wave, age, sex, race, bmi, handedness, education, education_f, education_m)
```

```{r}
gg_miss_var(ecas_final, show_pct = TRUE)
```
# Outputs

We write the output to RDS as well as the data dictionary.

```{r}
ecas_final %>%
  write_rds(here("outputs", "ecas_data.rds"))
```

```{r}
age <- list(
  LongName = "ParticipantAge",
  Description = "Participant age in years at the time of scan/intake. If original data is collected in months, the final value is divided by 12.",
  Units = "Years"
)

race <- list(
  LongName = "ParticipantRace",
  Description = "Participant's race.",
  Levels = levels(ecas_final$race)
)

sex <- list(
  LongName = "ParticipantSex",
  Description = "Participant's sex.",
  Levels = levels(ecas_final$sex)
)

bmi <- list(
  LongName = "ParticipantBMI",
  Description = "Participant's Body Mass Index. ",
  TermURL = "https://www.cdc.gov/nccdphp/dnpao/growthcharts/training/bmiage/page5_2.html",
  Units = "lbs/inches^2; BMI is normally reported without units."
)

handedness <- list(
  LongName = "ParticipantHandedness",
  Description = "Participant handedness. Either self-reported, or result of binarizing the Edinburgh Handedness Scale. Participants whose Edinburgh Handedness Scale value is 0 are reported as Ambidextrous",
  Levels = levels(ecas_final$handedness),
  TermURL = "https://en.wikipedia.org/wiki/Edinburgh_Handedness_Inventory"
)

education_years <- list(
  LongName = "ParticipantEducation",
  Description = "Participant education in years at time of scan/intake."
)

education_f <- list(
  LongName = "FatherEducation",
  Description = "Father's education level at time of scan/intake.",
  Levels = levels(ecas_final$education_f)
)

education_m <- list(
  LongName = "MotherEducation",
  Description = "Mother's education level at time of scan/intake.",
  Levels = levels(ecas_final$education_m)
)

wave <- list(
  LongName = "ParticipantWave",
  Description = "Participant's recruitment wave.",
  Levels = levels(ecas_final$wave)
)

study_site <- list(
  LongName = "ParticipantStudySite",
  Description = "Participant's study recruitment site.",
  Levels = levels(ecas_final$study_site)
)

study <- list(
  LongName = "ParticipantStudy",
  Description = "Participant's study.",
  Levels = levels(ecas_final$study)
)

list(age=age, 
     race=race, 
     sex=sex, 
     bmi=bmi, 
     handedness=handedness, 
     education_years=education_years, 
     education_f=education_f, 
     education_m=education_m, 
     wave=wave, 
     study_site=study_site, 
     study=study) %>%
  #jsonlite::toJSON(auto_unbox = TRUE) %>%
  #jsonlite::prettify() %>%
  jsonlite::write_json(here("outputs", "ecas_dictionary.json"), auto_unbox=TRUE, pretty=TRUE)
```

